import React, { useState } from 'react';
import { Shield, Heart, Send, AlertCircle, ChevronRight, Save, FileText, Star, Printer, Download } from 'lucide-react';
import { GoogleGenerativeAI } from "@google/generative-ai";

// --- КОНФІГУРАЦІЯ ---

// 1. ЯКЩО ТИ ХОСТИШ ЦЕ САМ (Frontend Only варіант):
const USER_PROVIDED_KEY = ""; 

// --- COMPONENTS ---

const Button = ({ children, onClick, variant = 'primary', disabled = false, className = '' }) => {
  const baseStyle = "px-6 py-3 font-mono text-sm uppercase tracking-wider font-bold transition-all duration-200 flex items-center justify-center gap-2 relative overflow-hidden select-none";
  
  const variants = {
    primary: "bg-stone-800 text-amber-50 hover:bg-stone-700 border-l-4 border-amber-600 shadow-lg active:translate-y-1",
    secondary: "bg-stone-200 text-stone-800 hover:bg-stone-300 border-l-4 border-stone-500 shadow-md",
    outline: "bg-transparent text-stone-800 border-2 border-stone-800 hover:bg-stone-100",
  };

  return (
    <button 
      onClick={onClick} 
      disabled={disabled}
      className={`${baseStyle} ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
    >
      {children}
    </button>
  );
};

const InputField = ({ label, value, onChange, placeholder, icon: Icon }) => (
  <div className="mb-6">
    <label className="block text-xs font-bold uppercase tracking-widest text-stone-500 mb-2 flex items-center gap-2">
      {Icon && <Icon size={14} />}
      {label}
    </label>
    <input
      type="text"
      value={value}
      onChange={(e) => onChange(e.target.value)}
      placeholder={placeholder}
      className="w-full bg-stone-100 border-b-2 border-stone-300 text-stone-900 p-3 font-serif focus:outline-none focus:border-amber-600 focus:bg-white transition-colors placeholder-stone-400"
    />
  </div>
);

const Card = ({ children, title, subtitle, className = '' }) => (
  <div className={`w-full max-w-2xl mx-auto bg-[#f4f4f0] shadow-2xl border border-stone-300 relative ${className}`}>
    {/* Folder Tab Look */}
    <div className="absolute -top-3 left-0 bg-stone-800 text-amber-50 px-4 py-1 text-xs font-mono uppercase tracking-widest shadow-sm">
      DOC-{Math.floor(Math.random() * 10000)} // TOP SECRET
    </div>
    
    <div className="p-8 md:p-12 relative">
       {/* Watermark */}
      <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-[0.03]">
        <Shield size={400} />
      </div>

      {title && (
        <div className="mb-8 border-b-2 border-stone-800 pb-4 text-center">
          <h2 className="text-2xl md:text-3xl font-black text-stone-800 uppercase tracking-tight font-serif">{title}</h2>
          {subtitle && <p className="text-stone-500 font-mono text-sm mt-2 uppercase tracking-widest">{subtitle}</p>}
        </div>
      )}
      <div className="relative z-10">
        {children}
      </div>
    </div>
    {/* Stamps visual decoration */}
    <div className="absolute bottom-4 right-4 opacity-20 rotate-[-15deg] border-4 border-red-800 text-red-800 p-2 font-black text-xl uppercase rounded pointer-events-none">
      Затверджено
    </div>
  </div>
);

// --- MAIN APP ---

export default function FamilyStatuteApp() {
  const [step, setStep] = useState('intro'); // intro, quiz, generating, result
  const [error, setError] = useState(null);
  const [generatedStatute, setGeneratedStatute] = useState('');
  
  const [formData, setFormData] = useState({
    husbandName: '',
    husbandCallsign: '',
    wifeName: '',
    wifeCallsign: '',
    conflictWeapon: 'Мовчання', 
    peaceTreaty: 'Смачна вечеря',
    financeChief: 'Спільний бюджет', 
    strategicGoal: 'Побудувати дім', 
  });

  const generateDirectly = async () => {
    setStep('generating');
    setError(null);

    try {
      const apiKey = USER_PROVIDED_KEY || ""; 
      
      const genAI = new GoogleGenerativeAI(apiKey);
      const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });

      const systemPrompt = `
        Ти - креативний військовий штабний писар з чудовим почуттям гумору.
        Твоє завдання: Написати жартівливий, але зворушливий "Бойовий Статут Сімейного Життя" (БССЖ) для молодят.
        Брат нареченого зараз служить у війську, тому стиль має бути псевдо-військовим, офіційним, з використанням термінів (дислокація, тил, спецзавдання, стратегічні запаси), але про мирне сімейне життя.

        Вхідні дані:
        - Чоловік (Командир 1): ${formData.husbandName} (Позивний: ${formData.husbandCallsign})
        - Дружина (Командир 2): ${formData.wifeName} (Позивний: ${formData.wifeCallsign})
        - Зброя у конфліктах: ${formData.conflictWeapon}
        - Спосіб примирення: ${formData.peaceTreaty}
        - Хто керує фінансами: ${formData.financeChief}
        - Стратегічна ціль: ${formData.strategicGoal}

        Структура відповіді (обов'язково Markdown):
        1. Заголовок (Урочистий).
        2. Преамбула (Про створення нового бойового підрозділу "Сім'я").
        3. Розділ 1: Ієрархія та Субординація (жартівливо обіграти рівноправ'я або особливості їх відповідей).
        4. Розділ 2: Тилове забезпечення (про фінанси та їжу).
        5. Розділ 3: Бойові дії та Перемир'я (використати дані про конфлікти та примирення).
        6. Розділ 4: Стратегічні цілі (про їх мрію).
        7. Фінальний наказ (Бажання щастя, любові та перемоги).

        Тон: Повага до військової справи, але дуже теплий, сімейний і смішний.
        Мова: Українська.
      `;

      const result = await model.generateContent({
        contents: [{ parts: [{ text: systemPrompt }] }],
      });

      const text = result.response.text();
      setGeneratedStatute(text);
      setStep('result');

    } catch (err) {
      console.error("AI Error:", err);
      setError("Штаб не відповідає. Перевірте з'єднання.");
      setStep('quiz');
    }
  };

  // --- RENDER STEPS ---

  const renderIntro = () => (
    <Card title="Ініціалізація Підрозділу" subtitle="Реєстрація нового сімейного формування">
      <div className="space-y-4">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <InputField 
            label="Ім'я Нареченого" 
            value={formData.husbandName} 
            onChange={(v) => setFormData({...formData, husbandName: v})}
            placeholder="Віктор"
            icon={Star}
          />
           <InputField 
            label="Позивний (Для сім'ї)" 
            value={formData.husbandCallsign} 
            onChange={(v) => setFormData({...formData, husbandCallsign: v})}
            placeholder="Ведмідь / Генерал"
            icon={Shield}
          />
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <InputField 
            label="Ім'я Нареченої" 
            value={formData.wifeName} 
            onChange={(v) => setFormData({...formData, wifeName: v})}
            placeholder="Анастасія"
            icon={Heart}
          />
           <InputField 
            label="Позивний (Для сім'ї)" 
            value={formData.wifeCallsign} 
            onChange={(v) => setFormData({...formData, wifeCallsign: v})}
            placeholder="Лисичка / Шеф"
            icon={Shield}
          />
        </div>
        <div className="pt-6 flex justify-center">
          <Button 
            onClick={() => setStep('quiz')}
            disabled={!formData.husbandName || !formData.wifeName}
          >
            Підтвердити особовий склад <ChevronRight />
          </Button>
        </div>
      </div>
    </Card>
  );

  const renderQuiz = () => (
    <Card title="Тактичний Опитувальник" subtitle="Збір розвідувальних даних для статуту">
      <div className="space-y-6">
        
        <InputField 
          label="Основна тактика дружини у суперечці?" 
          value={formData.conflictWeapon} 
          onChange={(v) => setFormData({...formData, conflictWeapon: v})}
          placeholder="Плаче / Кричить / Мовчить"
          icon={AlertCircle}
        />

        <InputField 
          label="Найефективніший метод підписання миру?" 
          value={formData.peaceTreaty} 
          onChange={(v) => setFormData({...formData, peaceTreaty: v})}
          placeholder="Піца / Обійми / Секс"
          icon={Heart}
        />

        <InputField 
          label="Хто начальник фінчастини (бюджету)?" 
          value={formData.financeChief} 
          onChange={(v) => setFormData({...formData, financeChief: v})}
          placeholder="Разом / Дружина / Чоловік"
          icon={FileText}
        />

        <InputField 
          label="Головна стратегічна ціль на 5 років?" 
          value={formData.strategicGoal} 
          onChange={(v) => setFormData({...formData, strategicGoal: v})}
          placeholder="Дім / Діти / Подорож"
          icon={Star}
        />

        {error && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
            <strong className="font-bold">Увага! </strong>
            <span className="block sm:inline">{error}</span>
          </div>
        )}

        <div className="pt-6 flex justify-between">
           <Button variant="secondary" onClick={() => setStep('intro')}>
             Назад
           </Button>
           <Button onClick={generateDirectly}>
             Затвердити Статут <Send size={16} />
           </Button>
        </div>
      </div>
    </Card>
  );

  const renderLoading = () => (
    <div className="flex flex-col items-center justify-center min-h-[60vh] px-4 text-center">
      <div className="w-16 h-16 border-4 border-stone-300 border-t-amber-600 rounded-full animate-spin mb-8"></div>
      <h2 className="text-2xl font-bold text-stone-800 mb-2 font-mono uppercase">Обробка даних у штабі...</h2>
      <p className="text-stone-600 animate-pulse">Генерал Штучний Інтелект узгоджує пункти статуту...</p>
    </div>
  );

  const renderResult = () => (
    <div className="max-w-4xl mx-auto py-8 px-4">
      <div className="mb-6 flex flex-col md:flex-row justify-between items-center gap-4 no-print">
        <Button variant="secondary" onClick={() => setStep('intro')}>Створити новий</Button>
        <Button onClick={() => window.print()} variant="primary">
          <Printer size={16} /> Друкувати / Зберегти PDF
        </Button>
      </div>

      {/* Основний контейнер документа */}
      <div className="bg-white text-stone-900 p-8 md:p-16 shadow-2xl border-2 border-stone-800 relative print-container">
        {/* Header Decoration */}
        <div className="border-b-4 border-double border-stone-800 pb-6 mb-8 flex justify-between items-start">
          <div>
             <h1 className="text-3xl md:text-4xl font-black uppercase tracking-tighter mb-2 font-serif">
               Статут <br/> <span className="text-amber-700">Сімейного Підрозділу</span>
             </h1>
             <div className="flex items-center gap-2 text-stone-500">
                <Shield size={16} />
                <p className="font-mono text-xs uppercase tracking-widest">
                Наказ № {new Date().getFullYear()}-{Math.floor(Math.random() * 100)}
                </p>
             </div>
          </div>
          <div className="opacity-80 hidden sm:block">
            <div className="w-20 h-20 border-4 border-stone-800 rounded-full flex items-center justify-center">
                 <Star size={40} className="text-amber-700" fill="currentColor" />
            </div>
          </div>
        </div>

        {/* Content from AI */}
        <div className="prose prose-stone prose-lg max-w-none font-serif leading-relaxed whitespace-pre-line">
            {generatedStatute.split('\n').map((line, i) => {
                if (line.startsWith('##')) return <h2 key={i} className="text-xl font-bold mt-6 mb-3 uppercase border-b border-stone-300 pb-1 text-stone-800">{line.replace('##', '')}</h2>;
                if (line.startsWith('#')) return <h1 key={i} className="text-2xl font-black mt-8 mb-4 text-center uppercase tracking-wide">{line.replace('#', '')}</h1>;
                if (line.startsWith('*') || line.startsWith('-')) return <li key={i} className="ml-4 list-disc marker:text-amber-700">{line.replace(/[*|-]/, '')}</li>;
                if (line.trim() === '') return <br key={i}/>;
                return <p key={i} className="mb-2 text-justify">{line.replace(/\*\*(.*?)\*\*/g, '$1')}</p>;
            })}
        </div>

        {/* Footer Signature Area */}
        <div className="mt-16 pt-8 border-t-2 border-stone-800 grid grid-cols-2 gap-12 break-inside-avoid">
          <div>
            <p className="text-xs font-bold uppercase mb-12 tracking-widest">Командир 1 ({formData.husbandName})</p>
            <div className="h-px bg-stone-900 w-full relative">
                <span className="absolute top-2 left-0 text-[10px] text-stone-500 uppercase">Підпис</span>
            </div>
          </div>
          <div>
            <p className="text-xs font-bold uppercase mb-12 tracking-widest">Командир 2 ({formData.wifeName})</p>
            <div className="h-px bg-stone-900 w-full relative">
                 <span className="absolute top-2 left-0 text-[10px] text-stone-500 uppercase">Підпис</span>
            </div>
          </div>
        </div>

        <div className="mt-8 text-center">
            <p className="font-mono text-[10px] uppercase text-stone-400">
                Згенеровано системою бойового управління "Гіменей" • {new Date().toLocaleDateString('uk-UA')}
            </p>
        </div>
        
        {/* Stamp */}
        <div className="absolute bottom-32 right-16 opacity-70 rotate-[-12deg] border-[6px] border-amber-800 text-amber-800 p-4 font-black text-2xl uppercase rounded-lg hidden md:block print:block">
          ЗАТВЕРДЖЕНО<br/><span className="text-sm block text-center mt-1">ГЕНШТАБ ЛЮБОВІ</span>
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-stone-200 text-stone-800 font-sans selection:bg-amber-200 pb-20">
      <header className="bg-stone-900 text-stone-400 p-4 text-center text-xs font-mono uppercase tracking-[0.2em] shadow-md no-print">
        Military-Grade Family Planning System v1.0
      </header>
      
      <main className="container mx-auto pt-10 px-4 print:pt-0 print:px-0 print:max-w-none">
        {step === 'intro' && renderIntro()}
        {step === 'quiz' && renderQuiz()}
        {step === 'generating' && renderLoading()}
        {step === 'result' && renderResult()}
      </main>

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Roboto+Mono:wght@400;700&display=swap');
        .font-serif { font-family: 'Playfair Display', serif; }
        .font-mono { font-family: 'Roboto Mono', monospace; }

        @media print {
          @page { margin: 0; size: auto; }
          body { background-color: white; -webkit-print-color-adjust: exact; }
          .no-print { display: none !important; }
          .print-container {
            position: absolute; left: 0; top: 0; width: 100%; min-height: 100vh;
            margin: 0; padding: 40px !important; box-shadow: none !important; border: none !important;
            background-color: white !important;
          }
          * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
      `}</style>
    </div>
  );
}
